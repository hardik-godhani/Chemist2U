# Logrotate configuration for Chemist2U application
# 
# Installation:
#   sudo cp logrotate-chemist2u.conf /etc/logrotate.d/chemist2u
#   sudo chown root:root /etc/logrotate.d/chemist2u
#   sudo chmod 644 /etc/logrotate.d/chemist2u
#
# Test configuration:
#   sudo logrotate -d /etc/logrotate.d/chemist2u
#
# Force rotation (for testing):
#   sudo logrotate -f /etc/logrotate.d/chemist2u

# Application logs (PM2)
/home/root/apps/chemist2u/logs/*.log {
    # Rotate daily
    daily
    
    # Keep 14 days of logs
    rotate 14
    
    # Don't error if log file is missing
    missingok
    
    # Don't rotate empty logs
    notifempty
    
    # Compress old logs (saves disk space)
    compress
    
    # Delay compression until next rotation
    # (allows immediate access to previous log)
    delaycompress
    
    # Create new log file with these permissions
    create 0640 root root
    
    # Use date as suffix for rotated files
    dateext
    dateformat -%Y%m%d
    
    # Run these commands after rotation
    postrotate
        # Reload PM2 to reopen log files
        su - root -c "pm2 reloadLogs" > /dev/null 2>&1 || true
    endscript
    
    # Share scripts between log files (run postrotate once)
    sharedscripts
}

# Nginx access logs
/var/log/nginx/access.log {
    daily
    rotate 14
    missingok
    notifempty
    compress
    delaycompress
    create 0640 www-data adm
    dateext
    dateformat -%Y%m%d
    
    postrotate
        # Reload Nginx to reopen log files
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid` > /dev/null 2>&1 || true
    endscript
    
    sharedscripts
}

# Nginx error logs
/var/log/nginx/error.log {
    daily
    rotate 14
    missingok
    notifempty
    compress
    delaycompress
    create 0640 www-data adm
    dateext
    dateformat -%Y%m%d
    
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid` > /dev/null 2>&1 || true
    endscript
    
    sharedscripts
}
