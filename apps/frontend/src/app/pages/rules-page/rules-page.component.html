<div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 lg:py-8">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
    <!-- Rule Builder - Left Side (2/3) -->
    <div class="lg:col-span-2 order-2 lg:order-1">
      <mat-card class="shadow-lg">
        <mat-card-header class="pb-3 sm:pb-4">
          <mat-card-title class="flex flex-col sm:flex-row sm:items-center sm:justify-between w-full gap-3">
            <div class="flex items-start sm:items-center gap-2 sm:gap-3">
              <div class="flex-1">
                <h2 class="text-lg sm:text-2xl font-semibold m-0 leading-tight">
                  {{ editingRule ? 'Edit Rule' : 'Create New Rule' }}
                </h2>
                <p class="text-xs sm:text-sm text-gray-600 mt-1 font-normal">
                  Build complex audience segments
                </p>
              </div>
            </div>
            <button
              *ngIf="!editingRule"
              mat-icon-button
              (click)="resetRule()"
              matTooltip="Reset form"
              color="accent"
              class="flex-shrink-0 -mt-2 sm:mt-0"
            >
              <mat-icon>refresh</mat-icon>
            </button>
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="pt-3 sm:pt-4">
          <!-- Rule Name Input -->
          <mat-form-field appearance="outline" class="w-full mb-4">
            <mat-label>Rule Name</mat-label>
            <input
              matInput
              [(ngModel)]="ruleName"
              placeholder="Enter rule name..."
              required
            />
            <mat-icon matPrefix>label</mat-icon>
          </mat-form-field>

          <!-- Validation Errors -->
          <div *ngIf="validationResult && validationResult.errors.length > 0" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex items-start gap-2">
              <mat-icon class="text-red-600 text-xl">error</mat-icon>
              <div class="flex-1">
                <h4 class="text-sm font-semibold text-red-800 m-0 mb-2">Validation Errors</h4>
                <ul class="list-disc list-inside text-xs text-red-700 space-y-1 m-0">
                  <li *ngFor="let error of validationResult.errors">{{ error }}</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Validation Warnings -->
          <div *ngIf="validationResult && validationResult.warnings.length > 0" class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-start gap-2">
              <mat-icon class="text-yellow-600 text-xl">warning</mat-icon>
              <div class="flex-1">
                <h4 class="text-sm font-semibold text-yellow-800 m-0 mb-2">Warnings</h4>
                <ul class="list-disc list-inside text-xs text-yellow-700 space-y-1 m-0">
                  <li *ngFor="let warning of validationResult.warnings">{{ warning }}</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Rule Builder -->
          <div class="mb-4 sm:mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2 sm:mb-3">
              Conditions
            </label>
            <div class="bg-gray-50 rounded-lg p-2 sm:p-4 border border-gray-200">
              <app-rule-group
                [group]="currentCondition"
                [fields]="fields"
                [isRoot]="true"
                (conditionChange)="onConditionChange()"
              ></app-rule-group>
            </div>
          </div>

          <!-- Preview Count -->
          <mat-card class="mb-4 sm:mb-6 shadow-sm" style="background: linear-gradient(to right, #fce4ec, #ffeef3);">
            <mat-card-content class="py-3">
              <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div class="flex items-center gap-2 sm:gap-3">
                  <div>
                    <p class="text-xs sm:text-sm text-gray-600 m-0">Matching Contacts</p>
                    <p class="text-2xl sm:text-3xl font-bold text-gray-900 m-0">
                      {{ previewMatchCount }}
                      <span class="text-base sm:text-lg font-normal text-gray-600">/ {{ totalContacts }}</span>
                    </p>
                  </div>
                </div>
                <mat-spinner *ngIf="previewLoading" diameter="32" color="primary"></mat-spinner>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
            <button
              *ngIf="editingRule"
              mat-stroked-button
              (click)="cancelEdit()"
              color="warn"
              class="w-full sm:w-auto"
            >
              <mat-icon>close</mat-icon>
              Cancel
            </button>
            <button
              mat-raised-button
              color="primary"
              (click)="saveRule()"
              [disabled]="!ruleName || saving"
              class="flex-1"
            >
              <mat-spinner *ngIf="saving" diameter="20" class="mr-2"></mat-spinner>
              <mat-icon *ngIf="!saving">{{ editingRule ? 'update' : 'save' }}</mat-icon>
              <span class="hidden sm:inline">{{ saving ? 'Saving...' : (editingRule ? 'Update Rule' : 'Save Rule') }}</span>
              <span class="sm:hidden">{{ saving ? 'Saving...' : (editingRule ? 'Update' : 'Save') }}</span>
            </button>
          </div>

          <div *ngIf="saveMessage" class="mt-3 sm:mt-4 p-3 rounded-lg" [ngClass]="{
            'bg-green-100 text-green-800': saveSuccess,
            'bg-red-100 text-red-800': !saveSuccess
          }">
            <div class="flex items-center gap-2">
              <mat-icon class="text-xl flex-shrink-0">{{ saveSuccess ? 'check_circle' : 'error' }}</mat-icon>
              <span class="text-xs sm:text-sm font-medium">{{ saveMessage }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Rules List - Right Side (1/3) -->
    <div class="lg:col-span-1 order-1 lg:order-2">
      <mat-card class="shadow-lg lg:sticky lg:top-20">
        <mat-card-header class="pb-3 sm:pb-4">
          <mat-card-title class="flex items-center gap-2">
            <span class="text-base sm:text-lg">Saved Rules</span>
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="pt-3 sm:pt-4">
          <!-- Loading State -->
          <div *ngIf="rulesLoading" class="flex justify-center py-6 sm:py-8">
            <mat-spinner diameter="40" color="primary"></mat-spinner>
          </div>

          <!-- Rules List -->
          <div *ngIf="!rulesLoading && savedRules.length > 0" class="space-y-2">
            <mat-card
              *ngFor="let rule of savedRules"
              class="cursor-pointer hover:shadow-md transition-shadow"
              [class.border-2]="editingRule?.id === rule.id"
              [class.border-primary]="editingRule?.id === rule.id"
            >
              <mat-card-content class="py-2 sm:py-3">
                <div class="flex items-start justify-between mb-2">
                  <div class="flex-1 min-w-0">
                    <p class="font-medium text-gray-900 truncate text-sm m-0">{{ rule.name }}</p>
                    <p class="text-xs text-gray-500 mt-1 m-0 flex items-center gap-1" *ngIf="rule.createdAt">
                      <span class="hidden sm:inline">{{ formatDate(rule.createdAt) }}</span>
                    </p>
                  </div>
                </div>
                <div class="flex gap-2 mt-2 sm:mt-3">
                  <button
                    mat-stroked-button
                    color="primary"
                    (click)="editRule(rule)"
                    class="flex-1 !text-xs sm:!text-sm"
                  >
                    <mat-icon class="!text-base sm:!text-xl">edit</mat-icon>
                    <span class="hidden sm:inline">Edit</span>
                  </button>
                  <button
                    mat-stroked-button
                    color="warn"
                    (click)="deleteRule(rule.id)"
                    class="flex-1 !text-xs sm:!text-sm"
                  >
                    <mat-icon class="!text-base sm:!text-xl">delete</mat-icon>
                    <span class="hidden sm:inline">Delete</span>
                  </button>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Empty State -->
          <div
            *ngIf="!rulesLoading && savedRules.length === 0"
            class="text-center py-8 sm:py-12 text-gray-500"
          >
            <mat-icon class="text-5xl sm:text-6xl w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-2 sm:mb-3 text-gray-300">inbox</mat-icon>
            <p class="text-xs sm:text-sm font-medium">No saved rules yet</p>
            <p class="text-xs text-gray-400 mt-1">Create your first rule above</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
