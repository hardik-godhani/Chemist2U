name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: Build applications
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Verify build artifacts
        run: |
          echo "Checking build output..."
          ls -la dist/apps/frontend/browser/
          ls -la dist/apps/backend/
          
          if [ ! -f "dist/apps/frontend/browser/index.html" ]; then
            echo "‚ùå Frontend build failed - index.html not found"
            exit 1
          fi
          
          if [ ! -f "dist/apps/backend/main.js" ]; then
            echo "‚ùå Backend build failed - main.js not found"
            exit 1
          fi
          
          echo "‚úÖ Build artifacts verified"
          
      - name: Create deployment package
        run: |
          echo "Creating deployment package..."
          tar -czf deploy.tar.gz \
            dist/ \
            ecosystem.config.js \
            nginx.conf \
            .env.example \
            package.json \
            package-lock.json
          echo "‚úÖ Deployment package created"
          
      - name: Copy deployment package to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: ${{ secrets.DROPLET_PORT || 22 }}
          source: "deploy.tar.gz"
          target: "/home/root/apps/chemist2u/"
          
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: ${{ secrets.DROPLET_PORT || 22 }}
          script: |
            set -e
            cd /home/root/apps/chemist2u
            
            echo "üì¶ Extracting deployment package..."
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz
            
            echo "üîß Installing production dependencies..."
            if [ ! -f ".env" ]; then
              echo "‚ö†Ô∏è  No .env file found. Creating from .env.example..."
              cp .env.example .env
              echo "‚ùó Please update .env with production values!"
            fi
            
            echo "‚ôªÔ∏è  Restarting PM2 process..."
            if pm2 list | grep -q "chemist2u-api"; then
              pm2 reload chemist2u-api
              echo "‚úÖ PM2 process reloaded"
            else
              echo "üöÄ Starting PM2 process for the first time..."
              pm2 start ecosystem.config.js
              pm2 save
              echo "‚úÖ PM2 process started"
            fi
            
            echo "‚è≥ Waiting for application to start..."
            sleep 5
            
            echo "‚úÖ Deployment completed!"
            
      - name: Health check
        run: |
          echo "üè• Performing health check..."
          
          # Wait a bit more for the app to fully start
          sleep 3
          
          # Try health check with retry
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s "http://${{ secrets.DROPLET_HOST }}/api/health" > /dev/null; then
              echo "‚úÖ Health check passed!"
              curl -s "http://${{ secrets.DROPLET_HOST }}/api/health" | jq .
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying..."
            sleep 5
          done
          
          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1
          
      - name: Deployment summary
        if: always()
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ secrets.DROPLET_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** http://${{ secrets.DROPLET_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API:** http://${{ secrets.DROPLET_HOST }}/api" >> $GITHUB_STEP_SUMMARY
          echo "- **Health:** http://${{ secrets.DROPLET_HOST }}/api/health" >> $GITHUB_STEP_SUMMARY
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Check the logs above for details."
          echo "Common issues:"
          echo "  - SSH connection problems (check secrets)"
          echo "  - Build failures (check build logs)"
          echo "  - PM2 process issues (check server logs: pm2 logs)"
          echo "  - Health check timeout (check backend logs)"
